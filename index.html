<script>
  window.addEventListener("DOMContentLoaded", () => {
    const sdkStatus = document.getElementById("sdk-status");
    const messageOutput = document.getElementById("message-output");

    microsoftTeams.app.initialize().then(() => {
      sdkStatus.textContent = "✅ Microsoft Teams SDK initialized.";

      microsoftTeams.app.getContext().then((context) => {
        // Try subEntityId from SDK (fallback if launched via subEntityId path)
        if (context.subEntityId) {
          messageOutput.textContent = "📩 Message (SDK): " + context.subEntityId;
          return;
        }

        // Otherwise try parsing the ?context= param manually
        const params = new URLSearchParams(window.location.search);
        const contextParam = params.get("context");

        if (contextParam) {
          try {
            const decoded = decodeURIComponent(contextParam);
            const contextObj = JSON.parse(decoded);
            const message = contextObj.subEntityId;
            messageOutput.textContent = message
              ? "📩 Message (query param): " + message
              : "ℹ️ Context parsed, but no message.";
          } catch (e) {
            messageOutput.textContent = "❌ Error parsing context JSON.";
          }
        } else {
          messageOutput.textContent = "ℹ️ No message passed via SDK or URL.";
        }
      }).catch((err) => {
        messageOutput.textContent = "❌ Failed to get context: " + err;
      });
    }).catch((err) => {
      sdkStatus.textContent = "❌ SDK init failed: " + err;
    });
  });
</script>
